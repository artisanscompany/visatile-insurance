#!/bin/bash

# Enable jemalloc for reduced memory usage and latency
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Unset DATABASE_URL so Rails uses SQLite config from database.yml
# (Coolify may auto-inject a PostgreSQL DATABASE_URL from linked resources)
unset DATABASE_URL

if [ -z "${SECRET_KEY_BASE}" ]; then
  echo "ERROR: SECRET_KEY_BASE environment variable is not set"
  echo "Please configure SECRET_KEY_BASE in Coolify environment variables"
  echo "Generate with: docker run --rm <your-image> bundle exec rails secret"
  exit 1
fi

# Ensure storage directory exists for SQLite databases
mkdir -p /rails/storage

prepare_databases() {
  echo "========================================="
  echo "PREPARING DATABASES"
  echo "========================================="

  echo "-> Preparing primary database..."
  ./bin/rails db:prepare
  echo "   Primary database ready"

  # db:schema:load:queue is broken in Rails 8 with SQLite multi-database.
  # The rake task silently fails to load schemas into the correct connection.
  # Workaround: use Rails runner to establish each connection explicitly
  # and load the schema file at the Ruby level.
  # See: https://github.com/rails/solid_queue/issues/365
  echo "-> Verifying Solid database schemas..."
  ./bin/rails runner '
    {queue: "db/queue_schema.rb", cache: "db/cache_schema.rb", cable: "db/cable_schema.rb"}.each do |name, schema|
      schema_path = Rails.root.join(schema)
      next unless File.exist?(schema_path)

      config = ActiveRecord::Base.configurations.configs_for(env_name: Rails.env, name: name.to_s)
      next unless config

      ActiveRecord::Base.establish_connection(name)
      tables = ActiveRecord::Base.connection.tables - %w[schema_migrations ar_internal_metadata]

      if tables.empty?
        puts "   LOAD #{name}: loading #{schema}..."
        # Delete corrupt/empty SQLite file and reconnect
        db_path = config.database
        if db_path&.end_with?(".sqlite3") && File.exist?(db_path)
          File.delete(db_path)
          ActiveRecord::Base.establish_connection(name)
        end
        load(schema_path)
        new_tables = ActiveRecord::Base.connection.tables - %w[schema_migrations ar_internal_metadata]
        puts "   OK   #{name}: created #{new_tables.size} tables"
      else
        puts "   OK   #{name}: #{tables.size} tables exist"
      end
    end
    ActiveRecord::Base.establish_connection(:primary)
  '
  echo "   All databases verified"

  echo "========================================="
}

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  prepare_databases
fi

# If running the jobs worker, prepare the database
if [ "${1}" == "./bin/jobs" ]; then
  prepare_databases
fi

exec "${@}"
