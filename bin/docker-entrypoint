#!/bin/bash

# Enable jemalloc for reduced memory usage and latency
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Unset DATABASE_URL so Rails uses SQLite config from database.yml
# (Coolify may auto-inject a PostgreSQL DATABASE_URL from linked resources)
unset DATABASE_URL

if [ -z "${SECRET_KEY_BASE}" ]; then
  echo "ERROR: SECRET_KEY_BASE environment variable is not set"
  echo "Please configure SECRET_KEY_BASE in Coolify environment variables"
  echo "Generate with: docker run --rm <your-image> bundle exec rails secret"
  exit 1
fi

# Ensure storage directory exists for SQLite databases
mkdir -p /rails/storage

prepare_databases() {
  echo "========================================="
  echo "PREPARING DATABASES"
  echo "========================================="

  echo "→ Preparing primary database..."
  ./bin/rails db:prepare
  echo "✓ Primary database ready"

  # For Solid databases, use schema:load which is idempotent and
  # handles the case where migrations were recorded but tables
  # were never actually created (corrupt/empty SQLite file).
  echo "→ Preparing queue database (SolidQueue)..."
  ./bin/rails db:create:queue 2>/dev/null || true
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 ./bin/rails db:schema:load:queue
  echo "✓ Queue database ready"

  echo "→ Preparing cache database (SolidCache)..."
  ./bin/rails db:create:cache 2>/dev/null || true
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 ./bin/rails db:schema:load:cache
  echo "✓ Cache database ready"

  echo "→ Preparing cable database (SolidCable)..."
  ./bin/rails db:create:cable 2>/dev/null || true
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 ./bin/rails db:schema:load:cable
  echo "✓ Cable database ready"

  echo "========================================="
}

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  prepare_databases
fi

# If running the jobs worker, prepare the database
if [ "${1}" == "./bin/jobs" ]; then
  prepare_databases
fi

exec "${@}"
